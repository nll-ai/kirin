{% extends "base.html" %}

{% block title %}Add Backend - Kirin{% endblock %}

{% block breadcrumb %}
<span class="breadcrumb-separator">></span>
<span>Add Backend</span>
{% endblock %}

{% block header_title %}Add Storage Backend{% endblock %}
{% block header_description %}Configure a new storage location for your datasets{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <!-- Error Alert -->
    {% if error %}
    <div class="alert alert-error mb-6">
        <strong>⚠️ {{ error }}</strong>
        {% if existing_backend_id %}
        <div class="mt-2">
            <a href="/backend/{{ existing_backend_id }}" class="btn btn-primary btn-sm">
                Go to Existing Backend →
            </a>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <div class="panel">
        <div class="panel-header">
            <h2 class="panel-title">Backend Configuration</h2>
        </div>
        <div class="panel-content">
            <form method="POST" action="/backends/add" class="space-y-6">
                <!-- Backend Name -->
                <div class="form-group">
                    <label for="name" class="form-label required">Backend Name</label>
                    <input type="text" id="name" name="name" class="input" placeholder="Production S3 Data"
                           value="{{ form_data.name if form_data else '' }}" required>
                    <p class="text-sm text-muted-foreground mt-1">A friendly name for this storage location</p>
                </div>

                <!-- Storage Type -->
                <div class="form-group">
                    <label for="type" class="form-label required">Storage Type</label>
                    <select id="type" name="type" class="select" required onchange="updateFormFields()">
                        <option value="">Select storage type...</option>
                        {% for type in types %}
                        <option value="{{ type.value }}" {% if form_data and form_data.type == type.value %}selected{% endif %}>{{ type.label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Dynamic fields based on type -->
                <div id="type-fields" class="space-y-4">
                    <!-- Fields will be populated by JavaScript -->
                </div>

                <!-- Form Actions -->
                <div class="flex gap-3 pt-4">
                    <a href="/" class="btn btn-secondary">Cancel</a>
                    <button type="button" id="test-connection" class="btn btn-ghost" onclick="testConnection()" disabled>
                        <span id="test-spinner" class="spinner hidden"></span>
                        Test Connection
                    </button>
                    <button type="submit" class="btn btn-primary" id="save-backend" disabled>
                        Save Backend
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Form field configurations for each backend type
const typeFields = {
    local: [
        { name: 'root_dir', label: 'Directory Path', type: 'text', required: true, placeholder: '/path/to/data' }
    ],
    s3: [
        { name: 'bucket', label: 'Bucket Name', type: 'text', required: true, placeholder: 'my-bucket' },
        { name: 'prefix', label: 'Prefix (optional)', type: 'text', required: false, placeholder: 'kirin' },
        { name: 'region', label: 'Region', type: 'text', required: true, placeholder: 'us-west-2' },
        { name: 'key', label: 'Access Key ID', type: 'text', required: true, placeholder: 'AKIAIOSFODNN7EXAMPLE' },
        { name: 'secret', label: 'Secret Access Key', type: 'password', required: true, placeholder: '••••••••••••••••••••••••••••••••' }
    ],
    gcs: [
        { name: 'bucket', label: 'Bucket Name', type: 'text', required: true, placeholder: 'my-bucket' },
        { name: 'prefix', label: 'Prefix (optional)', type: 'text', required: false, placeholder: 'kirin' },
        { name: 'project', label: 'GCP Project ID', type: 'text', required: true, placeholder: 'my-gcp-project' },
        { name: 'token', label: 'Service Account JSON Path', type: 'text', required: false, placeholder: 'path/to/key.json or \'cloud\'' }
    ],
    azure: [
        { name: 'container', label: 'Container Name', type: 'text', required: true, placeholder: 'my-container' },
        { name: 'prefix', label: 'Prefix (optional)', type: 'text', required: false, placeholder: 'kirin' },
        { name: 'account_name', label: 'Storage Account Name', type: 'text', required: true, placeholder: 'mystorageaccount' },
        { name: 'account_key', label: 'Storage Account Key', type: 'password', required: false, placeholder: '••••••••••••••••••••••••••••••••' },
        { name: 'connection_string', label: 'Connection String', type: 'text', required: false, placeholder: 'DefaultEndpointsProtocol=https;...' }
    ],
    s3_compatible: [
        { name: 'service', label: 'Service', type: 'select', required: true, options: [
            { value: 'minio', label: 'Minio' },
            { value: 'backblaze_us_west', label: 'Backblaze B2 (US West)' },
            { value: 'backblaze_us_east', label: 'Backblaze B2 (US East)' },
            { value: 'digitalocean_nyc3', label: 'DigitalOcean Spaces (NYC3)' },
            { value: 'custom', label: 'Custom Endpoint' }
        ]},
        { name: 'bucket', label: 'Bucket Name', type: 'text', required: true, placeholder: 'my-bucket' },
        { name: 'prefix', label: 'Prefix (optional)', type: 'text', required: false, placeholder: 'kirin' },
        { name: 'endpoint_url', label: 'Custom Endpoint URL', type: 'text', required: false, placeholder: 'https://custom-s3-endpoint.com' },
        { name: 'key', label: 'Access Key ID', type: 'text', required: true, placeholder: 'minioadmin' },
        { name: 'secret', label: 'Secret Access Key', type: 'password', required: true, placeholder: '••••••••••••••••••••••••••••••••' }
    ]
};

function updateFormFields() {
    const type = document.getElementById('type').value;
    const container = document.getElementById('type-fields');

    if (!type || !typeFields[type]) {
        container.innerHTML = '';
        document.getElementById('save-backend').disabled = true;
        return;
    }

    const fields = typeFields[type];
    container.innerHTML = fields.map(field => {
        let input = '';
        const formData = {{ form_data | tojson if form_data else 'null' }};
        const value = formData ? formData[field.name] || '' : '';

        if (field.type === 'select') {
            input = `<select name="${field.name}" class="select" ${field.required ? 'required' : ''}>
                <option value="">Select ${field.label.toLowerCase()}...</option>
                ${field.options ? field.options.map(opt =>
                    `<option value="${opt.value}" ${value === opt.value ? 'selected' : ''}>${opt.label}</option>`
                ).join('') : ''}
            </select>`;
        } else if (field.type === 'password') {
            input = `<input type="password" name="${field.name}" class="input" placeholder="${field.placeholder || ''}" value="${value}" ${field.required ? 'required' : ''}>`;
        } else {
            input = `<input type="${field.type}" name="${field.name}" class="input" placeholder="${field.placeholder || ''}" value="${value}" ${field.required ? 'required' : ''}>`;
        }

        return `
            <div class="form-group">
                <label for="${field.name}" class="form-label ${field.required ? 'required' : ''}">${field.label}</label>
                ${input}
            </div>
        `;
    }).join('');

    document.getElementById('save-backend').disabled = false;
}

// Initialize form fields on page load if there's form data
document.addEventListener('DOMContentLoaded', function() {
    const typeSelect = document.getElementById('type');
    if (typeSelect.value) {
        updateFormFields();
    }
});

function testConnection() {
    const button = document.getElementById('test-connection');
    const spinner = document.getElementById('test-spinner');

    button.disabled = true;
    spinner.classList.remove('hidden');

    // Simulate connection test (in real implementation, this would be an AJAX call)
    setTimeout(() => {
        button.disabled = false;
        spinner.classList.add('hidden');
        alert('Connection test would be implemented here');
    }, 2000);
}
</script>
{% endblock %}
