{% extends "base.html" %}

{% block title %}{{ catalog.name }} - Kirin{% endblock %}

{% block breadcrumb %}
<span class="breadcrumb-separator">></span>
<span>{{ catalog.name }}</span>
{% endblock %}

{% block header_title %}{{ catalog.name }}{% endblock %}
{% block header_description %}Datasets in {{ catalog.name }} ({{ catalog.root_dir }}){% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Tabs -->
    <div class="tabs">
        <div class="tab-list">
            <button class="tab active" onclick="showDatasets()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14,2 14,8 20,8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10,9 9,9 8,9"></polyline>
                </svg>
                Datasets
            </button>
            <button class="tab" onclick="showCreateForm()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Create Dataset
            </button>
        </div>
    </div>

    <!-- Tab Content -->
    <div id="tab-content" class="tab-content">
        <!-- Datasets Tab -->
        <div id="datasets-tab" class="space-y-6">
            <!-- Search -->
            <div class="panel">
                <div class="panel-content">
                    <div class="form-group">
                        <label for="search-input" class="form-label">Search Datasets</label>
                        <input type="text" id="search-input" class="input" placeholder="Search by name or description...">
                    </div>
                </div>
            </div>

            <!-- Dataset Cards -->
            {% if lazy_loading %}
            <!-- Lazy Loading State -->
            <div class="text-center py-12">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" class="mx-auto mb-4 text-muted-foreground">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14,2 14,8 20,8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10,9 9,9 8,9"></polyline>
                </svg>
                <h3 class="text-lg font-semibold mb-2">Ready to explore datasets</h3>
                <p class="text-muted-foreground mb-4">
                    Click the button below to load datasets from this catalog.
                </p>
                <button onclick="loadDatasets()" class="btn btn-primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12c0 1.2-4.03 6-9 6s-9-4.8-9-6c0-1.2 4.03-6 9-6s9 4.8 9 6z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    Load Datasets
                </button>
            </div>
            {% elif datasets %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for dataset in datasets %}
        <div class="card" data-dataset-name="{{ dataset.name }}" data-dataset-description="{{ dataset.description or '' }}">
            <div class="card-header">
                <div class="flex items-center gap-2">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14,2 14,8 20,8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10,9 9,9 8,9"></polyline>
                    </svg>
                    <h3 class="card-title">{{ dataset.name }}</h3>
                </div>
                <p class="card-description">{{ dataset.description or "No description" }}</p>
            </div>

            <div class="card-content">
                <div class="space-y-2">
                    <div class="flex items-center gap-2">
                        <span class="badge">{{ dataset.commit_count }} commit{{ 's' if dataset.commit_count != 1 else '' }}</span>
                        {% if dataset.current_commit %}
                        <span class="badge badge-primary">{{ dataset.current_commit[:8] }}</span>
                        {% endif %}
                    </div>

                    {% if dataset.total_size > 0 %}
                    <div class="text-sm text-muted-foreground">
                        Size: {{ "%.1f"|format(dataset.total_size / (1024*1024)) }} MB
                    </div>
                    {% endif %}

                    {% if dataset.last_updated %}
                    <div class="text-sm text-muted-foreground">
                        Updated: {{ dataset.last_updated }}
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="card-footer">
                <a href="/catalog/{{ catalog.id }}/{{ dataset.name }}" class="btn btn-primary btn-sm">
                    View Dataset
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 12h14"></path>
                        <path d="M12 5l7 7-7 7"></path>
                    </svg>
                </a>
            </div>
        </div>
            {% endfor %}
            </div>
            {% elif ssl_issue %}
            <!-- SSL Certificate Issue -->
            <div class="text-center py-12">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" class="mx-auto mb-4 text-yellow-500">
                    <path d="M12 9v4"></path>
                    <path d="M12 17h.01"></path>
                    <circle cx="12" cy="12" r="10"></circle>
                </svg>
                <h3 class="text-lg font-semibold mb-2 text-yellow-600">SSL Certificate Issue</h3>
                <p class="text-muted-foreground mb-4">
                    The web UI is running in a pixi environment that lacks proper SSL certificates for cloud storage connections.
                </p>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4 max-w-2xl mx-auto">
                    <div class="flex items-start gap-3">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-yellow-600 mt-0.5">
                            <path d="M12 9v4"></path>
                            <path d="M12 17h.01"></path>
                            <circle cx="12" cy="12" r="10"></circle>
                        </svg>
                        <div>
                            <h4 class="font-medium text-yellow-800">Why This Happens</h4>
                            <p class="text-sm text-yellow-700 mt-1">
                                Your notebook works because it uses your system Python with proper SSL certificates.
                                The web UI runs in pixi environment which lacks SSL certificate configuration.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="space-y-2">
                    <p class="text-sm text-muted-foreground">You can still create new datasets, which will work normally.</p>
                    <button onclick="showCreateForm()" class="btn btn-primary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Create New Dataset
                    </button>
                </div>
            </div>
            {% elif error %}
            <!-- Error State -->
            <div class="text-center py-12">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" class="mx-auto mb-4 text-red-500">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
                <h3 class="text-lg font-semibold mb-2 text-red-600">Connection Error</h3>
                <p class="text-muted-foreground mb-4">{{ error }}</p>
                <button onclick="loadDatasets()" class="btn btn-primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12c0 1.2-4.03 6-9 6s-9-4.8-9-6c0-1.2 4.03-6 9-6s9 4.8 9 6z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    Try Again
                </button>
            </div>
            {% else %}
            <!-- Empty State -->
            <div class="text-center py-12">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" class="mx-auto mb-4 text-muted-foreground">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14,2 14,8 20,8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10,9 9,9 8,9"></polyline>
                </svg>
                <h3 class="text-lg font-semibold mb-2">Unable to list datasets</h3>
                <p class="text-muted-foreground mb-4">
                    Due to connection issues, we cannot list existing datasets. You can still create new datasets.
                </p>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                    <div class="flex items-start gap-3">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-yellow-600 mt-0.5">
                            <path d="M12 9v4"></path>
                            <path d="M12 17h.01"></path>
                            <circle cx="12" cy="12" r="10"></circle>
                        </svg>
                        <div>
                            <h4 class="font-medium text-yellow-800">Connection Note</h4>
                            <p class="text-sm text-yellow-700 mt-1">
                                If you're experiencing SSL certificate issues on macOS, datasets may not be listed here.
                                You can still create new datasets which will work normally.
                            </p>
                        </div>
                    </div>
                </div>
                <button onclick="showCreateForm()" class="btn btn-primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Create New Dataset
                </button>
            </div>
            {% endif %}
        </div>

        <!-- Create Dataset Tab -->
        <div id="create-tab" class="space-y-6 hidden">
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">Create New Dataset</h2>
                </div>
                <div class="panel-content">
                    <!-- Error Alert for Dataset Creation -->
                    {% if error and existing_dataset_name %}
                    <div class="alert alert-error mb-4">
                        <strong>⚠️ {{ error }}</strong>
                        <div class="mt-2">
                            <a href="/catalog/{{ catalog.id }}/{{ existing_dataset_name }}" class="btn btn-primary btn-sm">
                                View Existing Dataset →
                            </a>
                        </div>
                    </div>
                    {% endif %}

                    <form method="POST" action="/catalog/{{ catalog.id }}/datasets/create" class="space-y-4">
                        <div class="form-group">
                            <label for="name" class="form-label required">Dataset Name</label>
                            <input type="text" id="name" name="name" class="input" placeholder="my-dataset" required>
                            <p class="text-sm text-muted-foreground mt-1">Use lowercase letters, numbers, and hyphens only</p>
                        </div>

                        <div class="form-group">
                            <label for="description" class="form-label">Description</label>
                            <textarea id="description" name="description" class="textarea" placeholder="Brief description of this dataset..."></textarea>
                        </div>

                        <div class="flex gap-3">
                            <button type="button" onclick="showDatasets()" class="btn btn-secondary">Cancel</button>
                            <button type="submit" class="btn btn-primary">Create Dataset</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function showDatasets() {
    // Update tab states
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    event.target.classList.add('active');

    // Show datasets tab, hide create tab
    document.getElementById('datasets-tab').classList.remove('hidden');
    document.getElementById('create-tab').classList.add('hidden');
}

function showCreateForm() {
    // Update tab states
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    event.target.classList.add('active');

    // Show create tab, hide datasets tab
    document.getElementById('create-tab').classList.remove('hidden');
    document.getElementById('datasets-tab').classList.add('hidden');

    // Focus on name field
    document.getElementById('name').focus();
}

// Search functionality
function filterDatasets() {
    const searchInput = document.getElementById('search-input');
    const searchTerm = searchInput.value.toLowerCase().trim();
    const datasetCards = document.querySelectorAll('.card[data-dataset-name]');

    datasetCards.forEach(card => {
        const datasetName = card.getAttribute('data-dataset-name').toLowerCase();
        const datasetDescription = card.getAttribute('data-dataset-description').toLowerCase();

        const matchesSearch = searchTerm === '' ||
                             datasetName.includes(searchTerm) ||
                             datasetDescription.includes(searchTerm);

        if (matchesSearch) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

// Load datasets function for lazy loading
function loadDatasets() {
    // Show loading state
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="animate-spin"><circle cx="12" cy="12" r="10"></circle><path d="M12 6v6l4 2"></path></svg> Loading...';
    button.disabled = true;

    // Navigate to the load datasets endpoint
    window.location.href = '/catalog/{{ catalog.id }}/datasets/load';
}

// Show create form if there's an error
document.addEventListener('DOMContentLoaded', function() {
    {% if error and existing_dataset_name %}
    showCreateForm();
    {% endif %}

    // Add search event listener
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.addEventListener('input', filterDatasets);
    }
});
</script>
{% endblock %}
