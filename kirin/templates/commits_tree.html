{% if commits %}
    <div class="commit-tree-container" id="commit-tree-container">
        <div class="commit-tree-graph" id="commit-tree-graph">
            <!-- Mermaid diagram will be rendered here -->
            <div id="tree-loading" style="text-align: center; padding: 2rem; color: hsl(var(--muted-foreground));">
                <div class="spinner" style="margin: 0 auto 1rem;"></div>
                <p>Loading commit tree...</p>
            </div>
        </div>

        <!-- Commit details for interaction -->
        <div class="commit-tree-details" style="display: none;">
            {% for commit in commits %}
            <div
                class="commit-tree-item"
                data-commit-hash="{{ commit.hash }}"
                data-short-hash="{{ commit.short_hash }}"
                data-message="{{ commit.message }}"
                data-file-count="{{ commit.file_count }}"
                data-is-merge="{{ commit.is_merge }}"
                data-parent-hash="{{ commit.parent_hash }}"
                data-parent-hashes="{{ commit.parent_hashes | join(',') }}"
            ></div>
            {% endfor %}
        </div>
    </div>

    {% if has_more %}
    <div
        id="load-more-tree-trigger"
        hx-get="/commits-tree?offset={{ offset }}&limit=20"
        hx-trigger="intersect once"
        hx-swap="beforeend"
        style="padding: 1rem; text-align: center; color: hsl(var(--muted-foreground)); font-size: 0.75rem;"
    >
        <div class="spinner" style="margin: 0 auto 0.5rem;"></div>
        <span>Loading more commits...</span>
    </div>
    {% endif %}
{% else %}
    <div class="empty-state">
        <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="margin: 0 auto; display: block;">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
        </svg>
        <p>No commits yet</p>
    </div>
{% endif %}

<script>
// Global variable to store all commits for the tree
window.allTreeCommits = window.allTreeCommits || [];
window.currentTreeCommitHash = '{{ current_commit_hash }}';

// Generate Mermaid diagram for commit tree
function initializeTree() {
    // Prevent multiple executions
    if (window.treeInitialized) {
        console.log('Tree already initialized, skipping...');
        return;
    }
    window.treeInitialized = true;

    console.log('initializeTree called');

    const newCommits = JSON.parse('{{ commits | tojson | safe }}');
    const currentCommitHash = '{{ current_commit_hash }}';

    console.log('Commits loaded:', newCommits);
    console.log('Current commit:', currentCommitHash);

    // First, try a simple test
    let graphDiv = document.getElementById('commit-tree-graph');
    if (!graphDiv) {
        console.error('Graph div not found');
        return;
    }

    console.log('Graph div found');

    // Try a very simple test first
    const simpleTest = 'graph TD\n    A[Hello]\n    B[World]\n    A --> B';
    console.log('Trying simple test:', simpleTest);

    graphDiv.innerHTML = simpleTest;

    if (typeof mermaid === 'undefined') {
        console.error('Mermaid is not available');
        graphDiv.innerHTML = '<div style="text-align: center; padding: 2rem; color: red;">Mermaid library not loaded</div>';
        return;
    }

    console.log('Mermaid is available, version:', mermaid.version);

    // Try to render the simple test
    try {
        mermaid.initialize({
            startOnLoad: false,
            theme: 'base'
        });

        mermaid.init(undefined, graphDiv).then(() => {
            console.log('Simple test rendered successfully!');
        }).catch(error => {
            console.error('Simple test failed:', error);
            graphDiv.innerHTML = `<div style="color: red;">Simple test failed: ${error.message}</div>`;
        });
    } catch (error) {
        console.error('Mermaid initialization failed:', error);
        graphDiv.innerHTML = `<div style="color: red;">Mermaid init failed: ${error.message}</div>`;
        return;
    }

    if (newCommits.length === 0) {
        console.log('No commits, showing empty state');
        return;
    }

    // Add new commits to the global list (for pagination)
    newCommits.forEach(commit => {
        if (!window.allTreeCommits.find(c => c.hash === commit.hash)) {
            window.allTreeCommits.push(commit);
        }
    });

    // Sort commits chronologically (newest first)
    window.allTreeCommits.sort((a, b) => {
        // Simple sort by hash for now - in a real implementation,
        // you'd want to sort by commit date or use the existing ordering
        return b.hash.localeCompare(a.hash);
    });

    // Generate Mermaid diagram with all commits
    const mermaidCode = generateCommitTreeMermaid(window.allTreeCommits, currentCommitHash);
    console.log('Generated Mermaid code:', mermaidCode);

    // Test with a simple diagram first
    const testCode = 'graph TD\n    A[Test Node]\n    B[Another Node]\n    A --> B';
    console.log('Test Mermaid code:', testCode);

    // Use the existing graphDiv variable
    console.log('Graph div found, setting innerHTML...');
    // Try the test code first to see if Mermaid works
    graphDiv.innerHTML = testCode;
    console.log('Graph div innerHTML set to:', graphDiv.innerHTML);

    // Initialize Mermaid if available
    if (typeof mermaid !== 'undefined') {
        console.log('Mermaid is available, initializing...');
        console.log('Mermaid version:', mermaid.version);
        mermaid.initialize({
            startOnLoad: false,
            theme: 'base',
            themeVariables: {
                primaryColor: '#3b82f6',
                primaryTextColor: '#ffffff',
                primaryBorderColor: '#e5e7eb',
                lineColor: '#6b7280',
                secondaryColor: '#f3f4f6',
                tertiaryColor: '#f9fafb'
            }
        });

        // Hide loading indicator
        const loadingDiv = document.getElementById('tree-loading');
        if (loadingDiv) {
            loadingDiv.style.display = 'none';
        }

        // Render the diagram
        mermaid.init(undefined, graphDiv).then(() => {
            console.log('Mermaid diagram rendered successfully');
            // Add click handlers after rendering
            setTimeout(addCommitClickHandlers, 100);
        }).catch(error => {
            console.error('Mermaid rendering error:', error);
            // Show error message with the raw code for debugging
            graphDiv.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: hsl(var(--destructive));">
                    <p>Error rendering commit tree. Please try refreshing the page.</p>
                    <details style="margin-top: 1rem; text-align: left;">
                        <summary>Debug Info</summary>
                        <pre style="background: #f5f5f5; padding: 1rem; margin-top: 0.5rem; font-size: 0.8rem; overflow-x: auto;">${mermaidCode}</pre>
                    </details>
                </div>
            `;
        });
    } else {
        console.error('Mermaid is not available');
        // Show fallback message
        graphDiv.innerHTML = '<div style="text-align: center; padding: 2rem; color: hsl(var(--muted-foreground));">Mermaid library not loaded. Please refresh the page.</div>';
    }

    // Add a timeout fallback in case Mermaid doesn't load
    setTimeout(() => {
        const loadingDiv = document.getElementById('tree-loading');
        if (loadingDiv && loadingDiv.style.display !== 'none') {
            console.log('Mermaid timeout - showing fallback');
            graphDiv.innerHTML = '<div style="text-align: center; padding: 2rem; color: hsl(var(--muted-foreground));">Loading commit tree... If this persists, please refresh the page.</div>';
        }
    }, 5000);
}

// Wait for both DOM and Mermaid to be ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing tree...');
    // Wait a bit for Mermaid to load
    setTimeout(initializeTree, 500);
});

// Also try when window loads
window.addEventListener('load', function() {
    console.log('Window loaded, initializing tree...');
    setTimeout(initializeTree, 500);
});

// Try immediately as well
console.log('Script loaded, trying immediate initialization...');
setTimeout(initializeTree, 1000);

function generateCommitTreeMermaid(commits, currentCommitHash) {
    if (commits.length === 0) {
        return 'graph TD\n    A[No commits yet]';
    }

    console.log('Generating tree for commits:', commits.length);
    console.log('Current commit hash:', currentCommitHash);

    // Build the graph structure
    let lines = ['graph TD'];

    // Create nodes for each commit
    commits.forEach((commit, index) => {
        const isActive = commit.hash === currentCommitHash;
        const nodeId = `commit_${commit.short_hash}`;
        const nodeLabel = `${commit.short_hash}\\n${commit.message || '(initial commit)'}`;

        console.log(`Creating node for commit ${commit.short_hash}, active: ${isActive}`);

        // Style active commit differently
        if (isActive) {
            lines.push(`${nodeId}["${nodeLabel}"]:::active`);
        } else {
            lines.push(`${nodeId}["${nodeLabel}"]`);
        }
    });

    // Add connections between commits
    commits.forEach((commit, index) => {
        if (commit.parent_hash) {
            const parentCommit = commits.find(c => c.hash === commit.parent_hash);
            if (parentCommit) {
                const nodeId = `commit_${commit.short_hash}`;
                const parentNodeId = `commit_${parentCommit.short_hash}`;
                lines.push(`${nodeId} --> ${parentNodeId}`);
                console.log(`Adding connection: ${nodeId} --> ${parentNodeId}`);
            }
        }
    });

    // Add styling classes
    lines.push('classDef active fill:#3b82f6,stroke:#1d4ed8,color:#ffffff');
    lines.push('classDef default fill:#f3f4f6,stroke:#d1d5db,color:#374151');

    const result = lines.join('\\n');
    console.log('Generated Mermaid code:', result);
    return result;
}

function addCommitClickHandlers() {
    // Add click handlers to Mermaid nodes
    const graphDiv = document.getElementById('commit-tree-graph');
    if (graphDiv) {
        const svg = graphDiv.querySelector('svg');
        if (svg) {
            // Find all commit nodes and add click handlers
            const nodes = svg.querySelectorAll('g.node');
            nodes.forEach(node => {
                const textElement = node.querySelector('text');
                if (textElement) {
                    const text = textElement.textContent;
                    const commitHash = text.split('\\n')[0]; // First line is the hash

                    // Find the commit data
                    const commit = window.allTreeCommits.find(c => c.short_hash === commitHash);
                    if (commit) {
                        node.style.cursor = 'pointer';
                        node.addEventListener('click', function() {
                            // Load files for this commit
                            htmx.ajax('GET', `/commit/${commit.hash}/files`, {
                                target: '#files-list',
                                swap: 'innerHTML'
                            });

                            // Update URL
                            updateCommitUrl(commit.hash);
                        });
                    }
                }
            });
        }
    }
}

// Handle HTMX events for pagination
document.addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.xhr.status === 200 && event.detail.pathInfo.requestPath.includes('/commits-tree')) {
        // Re-render the tree with updated commits
        const commits = window.allTreeCommits;
        const currentCommitHash = window.currentTreeCommitHash;

        if (commits.length > 0) {
            const mermaidCode = generateCommitTreeMermaid(commits, currentCommitHash);
            const graphDiv = document.getElementById('commit-tree-graph');
            if (graphDiv) {
                graphDiv.innerHTML = mermaidCode;

                if (typeof mermaid !== 'undefined') {
                    mermaid.init(undefined, graphDiv).then(() => {
                        setTimeout(addCommitClickHandlers, 100);
                    });
                }
            }
        }
    }
});
</script>
