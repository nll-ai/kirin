{% extends "base.html" %}

{% block title %}Kirin - {{ dataset_name }}{% endblock %}

{% block extra_styles %}
<style>
    .panel-content {
        max-height: 70vh;
        overflow-y: auto;
    }
</style>
<script>
    function updateCommitUrl(commitHash) {
        // Update URL to include commit hash for bookmarking
        const url = new URL(window.location);
        url.searchParams.set('commit', commitHash);
        window.history.pushState({}, '', url);
    }

    function showCommitLoading(commitElement) {
        // Remove loading state from all other commit items
        document.querySelectorAll('.commit-item.loading').forEach(item => {
            item.classList.remove('loading');
        });

        // Add loading class to show spinner on clicked item
        commitElement.classList.add('loading');

        // Remove loading state when HTMX request completes
        commitElement.addEventListener('htmx:afterRequest', function() {
            commitElement.classList.remove('loading');
        }, { once: true });

        // Also remove loading state on error
        commitElement.addEventListener('htmx:responseError', function() {
            commitElement.classList.remove('loading');
        }, { once: true });
    }

    // View switching functionality
    let currentView = 'list'; // 'list' or 'tree'

    function switchToListView() {
        if (currentView === 'list') return;

        currentView = 'list';
        updateViewToggleButtons();
        updateViewUrl();

        // Reset tree initialization flag
        window.treeInitialized = false;

        // Load list view
        htmx.ajax('GET', '/commits', {
            target: '#commits-list',
            swap: 'innerHTML'
        });
    }

    function switchToTreeView() {
        if (currentView === 'tree') return;

        currentView = 'tree';
        updateViewToggleButtons();
        updateViewUrl();

        // Reset tree initialization flag
        window.treeInitialized = false;

        // Load tree view
        htmx.ajax('GET', '/commits-tree', {
            target: '#commits-list',
            swap: 'innerHTML'
        });
    }

    function updateViewToggleButtons() {
        const listBtn = document.getElementById('view-toggle-list');
        const treeBtn = document.getElementById('view-toggle-tree');

        if (currentView === 'list') {
            listBtn.classList.add('active');
            treeBtn.classList.remove('active');
        } else {
            listBtn.classList.remove('active');
            treeBtn.classList.add('active');
        }
    }

    // Initialize view from URL parameters
    function initializeView() {
        const urlParams = new URLSearchParams(window.location.search);
        const view = urlParams.get('view');

        if (view === 'tree') {
            switchToTreeView();
        } else {
            switchToListView();
        }
    }

    // Update URL when view changes
    function updateViewUrl() {
        const url = new URL(window.location);
        if (currentView === 'tree') {
            url.searchParams.set('view', 'tree');
        } else {
            url.searchParams.delete('view');
        }
        window.history.pushState({}, '', url);
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        initializeView();
    });
</script>
{% endblock %}

{% block content %}
<div class="container">
    <div class="nav-bar">
        <div class="breadcrumb">
            <a href="/" class="btn btn-ghost">‚Üê Home</a>
            <span class="breadcrumb-separator">/</span>
            <span class="font-mono">{{ dataset_name }}</span>
            <span class="breadcrumb-separator">@</span>
            <span class="badge font-mono">{{ current_branch }}</span>
            <span class="breadcrumb-separator">#</span>
            <span class="badge font-mono">{{ current_commit_hash }}</span>
        </div>
    </div>

    <div class="header">
        <div class="flex items-center justify-between">
            <div>
                <h1>{{ dataset_name }}</h1>
                <p class="text-muted font-mono text-sm">{{ root_dir }}</p>
            </div>
            <div class="flex gap-2">
                <a href="/branches" class="btn btn-secondary">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path>
                    </svg>
                    Branches
                </a>
                <a href="/commit" class="btn btn-primary">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    New Commit
                </a>
            </div>
        </div>
    </div>

    <div class="dataset-container">
        <!-- Commits Panel (Left) -->
        <div class="panel">
            <div class="panel-header">
                <div class="flex items-center justify-between">
                    <h2 class="panel-title">Commits</h2>
                    <div class="flex gap-2">
                        <button
                            id="view-toggle-list"
                            class="btn btn-sm btn-secondary view-toggle active"
                            onclick="switchToListView()"
                        >
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                            </svg>
                            List
                        </button>
                        <button
                            id="view-toggle-tree"
                            class="btn btn-sm btn-secondary view-toggle"
                            onclick="switchToTreeView()"
                        >
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path>
                            </svg>
                            Tree
                        </button>
                    </div>
                </div>
            </div>
            <div class="panel-content" id="commits-list">
                {% include "commits_list.html" %}
            </div>
        </div>

        <!-- Files Panel (Right) -->
        <div>
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">Files</h2>
                </div>
                <div class="panel-content" id="files-list">
                    {% include "files_list.html" %}
                </div>
            </div>

            <!-- Loading indicator for files -->
            <div id="loading-files" style="display: none; text-align: center; padding: 2rem;">
                <div class="spinner" style="margin: 0 auto 1rem;"></div>
                <p>Loading files...</p>
            </div>

            <!-- File Preview -->
            <div id="file-preview"></div>
        </div>
    </div>
</div>
{% endblock %}

