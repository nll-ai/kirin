Fix the problem I just described and update tests to ensure they are working as expected.
